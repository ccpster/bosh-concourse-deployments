#!/bin/bash

set -eu

# env
: ${GOOGLE_CREDENTIALS:?}
: ${BOSH_DIRECTOR_SECRETS:?}
: ${BOSH_CLIENT:?}
: ${BOSH_CLIENT_SECRET:?}
: ${BOSH_CA_CERT:?}
: ${BOSH_CA_KEY:?}
: ${JUMPBOX_SSH_KEY:?}
: ${JUMPBOX_SSH_USER:?}
: ${ADDITIONAL_OPS:=""}
: ${JUMPBOX_PUBLIC_KEY:?}

source deployments-src/ci/utils

BOSH_CA_CERT="$( read_with_escaped_newlines "${BOSH_CA_CERT}" )"
BOSH_CA_KEY="$( read_with_escaped_newlines "${BOSH_CA_KEY}" )"

tmp_dir="$( mktemp -d /tmp/deploy-XXXXXX)"
trap "{ cleanup_tmp_dir '$tmp_dir'; }" EXIT # will be overridden by future trap calls

# remove `director_` prefix from keys to conform to bosh-deployment templates
terraform_metadata="${tmp_dir}/terraform_metadata"
jq 'with_entries(.key |= sub("^director_"; ""))' terraform/metadata > "${terraform_metadata}"

ssh_tunnel \
   "${JUMPBOX_SSH_KEY}" \
   "${JUMPBOX_SSH_USER}@$(jq -r -e .jumpbox_external_ip $terraform_metadata)" \
   "$(jq -r -e .internal_ip $terraform_metadata)"

touch ops-file.yml
if [[ -n "${ADDITIONAL_OPS}" && -n "$( echo "${ADDITIONAL_OPS}" | base64 -d )" ]]; then
  bosh2 int <( echo "${ADDITIONAL_OPS}" | base64 -d ) --path /commands | while read -r CMD; do eval $CMD; done
  bosh2 int <( echo "${ADDITIONAL_OPS}" | base64 -d ) --path /ops_file_yml > ops-file.yml
fi

cp director-state/*.json updated-director-state
echo "Updating director..."
bosh2 -n create-env \
  -o director-templates/gcp/cpi.yml \
  -o director-templates/local-dns.yml \
  -o "${deployments_dir}/bosh/debug-ops-file.yml" \
  -o "${deployments_dir}/bosh/bootstrap-ops-file.yml" \
  -o "${deployments_dir}/bosh/datadog-ops-file.yml" \
  -o director-templates/uaa.yml \
  -o director-templates/jumpbox-user.yml \
  -o ops-file.yml \
  --vars-store "${tmp_dir}/throwaway-var-store" \
  -l <(echo "${BOSH_DIRECTOR_SECRETS}") \
  -l <(echo "${JUMPBOX_PUBLIC_KEY}") \
  -l "${terraform_metadata}" \
  -v "admin_user=${BOSH_CLIENT}" \
  -v "admin_password=${BOSH_CLIENT_SECRET}" \
  -v "default_ca={ \"certificate\": \"${BOSH_CA_CERT}\", \"private_key\": \"${BOSH_CA_KEY}\" }" \
  -v "gcp_credentials_json='${GOOGLE_CREDENTIALS}'" \
  --state updated-director-state/bosh-state.json \
  director-templates/bosh.yml

echo "Successfully updated director!"
