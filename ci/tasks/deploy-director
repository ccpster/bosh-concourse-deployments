#!/bin/bash

set -eu

deployments_dir="$( cd "$( dirname "$0" )" && cd ../.. && pwd )"
workspace_dir="$( cd "${deployments_dir}/.." && pwd )"

# env
: ${GOOGLE_CREDENTIALS:?}
: ${BOSH_DIRECTOR_SECRETS:?}
: ${BOSH_CLIENT:?}
: ${BOSH_CLIENT_SECRET:?}
: ${BOSH_CA_CERT:?}
: ${BOSH_CA_KEY:?}
: ${JUMPBOX_SSH_KEY:?}
: ${JUMPBOX_SSH_USER:=vcap}

# inputs
terraform_config="$( cd "${workspace_dir}/terraform" && pwd )"
director_templates_dir="$( cd "${workspace_dir}/director-templates" && pwd )"
director_state_dir="$( cd "${workspace_dir}/director-state" && pwd )"
bosh_cli=$( echo ${workspace_dir}/bosh-cli/bosh-cli-* )
chmod +x "${bosh_cli}"

# outputs
output_dir="$( cd "${workspace_dir}/updated-director-state" && pwd )"

read_with_escaped_newlines() {
  echo "$1" | perl -pe 's|\n|\\n|'
}
BOSH_CA_CERT="$( read_with_escaped_newlines "${BOSH_CA_CERT}" )"
BOSH_CA_KEY="$( read_with_escaped_newlines "${BOSH_CA_KEY}" )"

tmp_dir="$( mktemp -d /tmp/deploy-director-XXXXXXXX)"
cleanup_tmp_dir() {
  rm -rf "${tmp_dir}" || true
}
trap "{ cleanup_tmp_dir; }" EXIT # will be overridden by future trap calls

ssh_key_path="${tmp_dir}/id_rsa.pem"
echo "${JUMPBOX_SSH_KEY}" > "${ssh_key_path}"
chmod 400 "${ssh_key_path}"

cp "${director_templates_dir}/bosh.yml" "${output_dir}"
cp ${director_state_dir}/*.json "${output_dir}"

# remove `director_` prefix from keys to conform to bosh-deployment templates
terraform_metadata="${tmp_dir}/terraform_metadata"
jq 'with_entries(.key |= sub("^director_"; ""))' "${terraform_config}/metadata" > "${terraform_metadata}"

jumpbox_external_ip=$(jq -r -e .jumpbox_external_ip $terraform_metadata)
director_internal_ip=$(jq -r -e .internal_ip $terraform_metadata)

jumpbox_address="${JUMPBOX_SSH_USER}@${jumpbox_external_ip}"
ssh_args="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i ${ssh_key_path}"
ssh ${ssh_args} -M -S "${tmp_dir}/tunnel-socket" -fnNT -L 6868:${director_internal_ip}:6868 "${jumpbox_address}"
cleanup_ssh_tunnel() {
  ssh ${ssh_args} -S "${tmp_dir}/tunnel-socket" -O exit "${jumpbox_address}"
}
trap "{ cleanup_ssh_tunnel; cleanup_tmp_dir; }" EXIT

pushd "${output_dir}" > /dev/null
  echo "Updating director..."
  ${bosh_cli} -n create-env \
    --ops-file "${director_templates_dir}/gcp/cpi.yml" \
    --ops-file "${director_templates_dir}/local-dns.yml" \
    --ops-file "${deployments_dir}/bosh/debug-ops-file.yml" \
    --ops-file "${deployments_dir}/bosh/bootstrap-ops-file.yml" \
    --vars-store "${tmp_dir}/throwaway-var-store" \
    -l <(echo "${BOSH_DIRECTOR_SECRETS}") \
    -l "${terraform_metadata}" \
    -v "admin_user=${BOSH_CLIENT}" \
    -v "admin_password=${BOSH_CLIENT_SECRET}" \
    -v "default_ca={ \"certificate\": \"${BOSH_CA_CERT}\", \"private_key\": \"${BOSH_CA_KEY}\" }" \
    -v "gcp_credentials_json='${GOOGLE_CREDENTIALS}'" \
    ./bosh.yml
popd > /dev/null

echo "Successfully updated director!"
